<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
  :root{
    --bg:#0b1120;
    --bg-soft:#111827;
    --surface:#111827;
    --panel:#020617;
    --accent:#ef4444;
    --accent-soft:#fecaca;
    --ink:#f9fafb;
    --muted:#9ca3af;
    --soft:#1f2937;
    --shadow:0 18px 40px rgba(0,0,0,.55);
    --ring:0 0 0 2px rgba(248,113,113,.5);
    --stepGrad:#fefce8;
    --stepSide:#fed7aa;
    --yes:#22c55e;
    --no:#f97316;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  body{background:radial-gradient(circle at top,#1f2937 0,#020617 45%,#020617 100%);color:var(--ink);}

  /* ===== Top bar ===== */
  .topbar{
    display:flex;
    align-items:center;
    gap:.75rem;
    padding:.4rem 1rem .55rem;
    background:linear-gradient(90deg,#020617,#020617 20%,#111827 60%,#020617 100%);
    box-shadow:0 8px 22px rgba(0,0,0,.8);
    position:relative;
    z-index:20;
  }
  .logo{
    display:flex;
    align-items:center;
    gap:.5rem;
    font-weight:900;
    letter-spacing:.04em;
    font-size:20px;
    margin-right:.75rem;
  }
  .logo span.ear{font-size:26px;transform:translateY(1px)}
  .search{
    flex:1;
    max-width:360px;
    background:#020617;
    border-radius:999px;
    padding:.25rem .8rem;
    display:flex;
    align-items:center;
    gap:.35rem;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08),0 0 0 1px rgba(15,23,42,.8);
  }
  .search input{
    width:100%;border:0;background:transparent;outline:0;
    color:var(--ink);font-size:13px;
  }

  .btn3d{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    padding:.38rem .7rem;
    border-radius:999px;
    border:0;
    font-size:12px;
    font-weight:700;
    letter-spacing:.02em;
    cursor:pointer;
    color:#fee2e2;
    background:radial-gradient(circle at 20% 0,#f97373,#b91c1c);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.25),
      0 2px 0 rgba(127,29,29,1),
      0 9px 18px rgba(0,0,0,.85);
    white-space:nowrap;
  }
  .btn3d small{font-size:11px;font-weight:600}
  .btn3d:active{transform:translateY(1px);box-shadow:
      inset 0 1px 0 rgba(255,255,255,.2),
      0 1px 0 rgba(127,29,29,1),
      0 5px 12px rgba(0,0,0,.8);
  }
  .btn3d svg{width:13px;height:13px}
  .btn3d-ghost{
    background:#020617;
    color:#e5e7eb;
    box-shadow:
      inset 0 1px 0 rgba(148,163,184,.3),
      0 2px 0 rgba(15,23,42,1),
      0 9px 20px rgba(0,0,0,.9);
  }
  .btn3d-ghost span.icon{font-size:13px}

  .top-right{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:.45rem;
  }
  .stamp{
    padding:.2rem .7rem;
    border-radius:999px;
    font-size:11px;
    color:var(--muted);
    background:rgba(15,23,42,.9);
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35);
  }

  /* Departamento selector */
  .dept-wrap{
    display:flex;
    align-items:center;
    gap:.4rem;
    margin-left:1.2rem;
  }
  .dept-select{
    background:#020617;
    color:#e5e7eb;
    border-radius:999px;
    padding:.32rem .7rem;
    border:1px solid rgba(148,163,184,.6);
    font-size:12px;
    cursor:pointer;
  }

  /* ===== Layout main ===== */
  .layout{
    height:calc(100% - 52px);
    display:grid;
    grid-template-columns:310px minmax(0,1fr);
    overflow:hidden;
  }
  @media (max-width:960px){
    .layout{grid-template-columns:1fr;grid-template-rows:260px minmax(0,1fr);}
  }

  /* LEFT: Departments + processes */
  .left{
    background:radial-gradient(circle at 0 0,#1f2937 0,#020617 55%);
    border-right:1px solid rgba(15,23,42,.9);
    padding:10px 10px 12px;
    overflow-y:auto;
  }
  .dept-block{
    margin-bottom:10px;
    border-radius:16px;
    background:rgba(15,23,42,.96);
    box-shadow:0 12px 30px rgba(0,0,0,.9);
    padding:6px 6px 8px;
  }
  .dept-head{
    display:flex;
    align-items:center;
    gap:.4rem;
    padding:.25rem .5rem .4rem;
  }
  .dept-title{
    flex:1;
    font-size:13px;
    font-weight:800;
    cursor:pointer;
  }
  .dept-tag{
    font-size:11px;
    padding:.12rem .45rem;
    border-radius:999px;
    background:#4b5563;
    color:#e5e7eb;
  }

  .proc-list{
    margin-top:4px;
    padding-top:4px;
    border-top:1px solid rgba(31,41,55,.9);
  }

  .proc-item{
    display:flex;
    flex-direction:column;
    gap:.25rem;
    padding:.35rem .45rem;
    margin-bottom:4px;
    border-radius:12px;
    background:linear-gradient(135deg,#020617,#020617 40%,#111827 100%);
    box-shadow:0 1px 0 rgba(148,163,184,.7);
    cursor:pointer;
  }
  .proc-item.active{
    box-shadow:var(--ring),0 1px 0 rgba(148,163,184,.9);
  }
  .proc-main{
    display:flex;
    align-items:center;
    gap:.4rem;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    box-shadow:inset 0 0 0 2px rgba(15,23,42,.85);
  }
  .proc-name{
    flex:1;
    font-size:13px;
    font-weight:800;
  }
  .proc-actions{
    display:flex;
    align-items:center;
    gap:.25rem;
  }
  .icon-btn{
    width:26px;
    height:26px;
    border-radius:999px;
    border:0;
    background:#020617;
    color:#e5e7eb;
    cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35),0 2px 0 rgba(15,23,42,1);
    font-size:13px;
  }
  .icon-btn:active{transform:translateY(1px);}

  .proc-detail{
    display:none;
    margin-top:2px;
  }
  .proc-detail textarea{
    width:100%;
    min-height:60px;
    border-radius:10px;
    border:1px solid rgba(55,65,81,.9);
    background:#020617;
    color:#e5e7eb;
    font-size:12px;
    padding:.35rem .45rem;
  }

  /* RIGHT: board */
  .right{
    background:radial-gradient(circle at 0 0,#111827 0,#020617 40%,#020617 100%);
    padding:10px;
    overflow:auto;
    position:relative;
  }

  .board-head{
    display:flex;
    align-items:center;
    gap:.6rem;
    margin-bottom:10px;
  }
  .board-title{
    flex:1;
    background:radial-gradient(circle at 0 0,#1f2937 0,#020617 50%);
    padding:.55rem .9rem;
    border-radius:18px;
    display:flex;
    align-items:center;
    gap:.75rem;
    box-shadow:0 12px 30px rgba(0,0,0,.9);
  }
  .board-title strong{
    font-size:15px;
    letter-spacing:.03em;
  }
  .board-title small{
    font-size:11px;
    color:var(--muted);
  }

  .board-head-controls{
    display:flex;
    align-items:center;
    gap:.4rem;
  }

  /* Common pill buttons (black) */
  .pill-black{
    background:#020617;
    color:#e5e7eb;
    border-radius:999px;
    border:1px solid rgba(31,41,55,.9);
    padding:.38rem .75rem;
    font-size:12px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    cursor:pointer;
    box-shadow:
      inset 0 1px 0 rgba(148,163,184,.25),
      0 2px 0 rgba(15,23,42,1),
      0 8px 18px rgba(0,0,0,.8);
  }
  .pill-black:active{transform:translateY(1px);}

  /* ===== Steps board ===== */
  .modules{
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-bottom:40px;
  }

  .module{
    position:relative;
    background:radial-gradient(circle at 0 0,#020617 0,#020617 50%,#020617 100%);
    border-radius:18px;
    padding:8px 8px 10px;
    box-shadow:0 12px 30px rgba(0,0,0,.95);
  }
  .module.sub-child{
    border:1px dashed rgba(248,250,252,.2);
    box-shadow:0 10px 24px rgba(0,0,0,.8);
  }

  .mod-head{
    display:flex;
    align-items:center;
    gap:.4rem;
    padding:.35rem .55rem .45rem;
    border-radius:14px;
    background:radial-gradient(circle at 0 0,#020617,#020617 55%,#020617 100%);
  }
  .mod-title{
    flex:1;
    border:0;
    outline:0;
    background:transparent;
    color:var(--ink);
    font-weight:800;
    font-size:13px;
  }
  .mod-select{
    border-radius:999px;
    border:1px solid rgba(55,65,81,.9);
    background:#020617;
    color:#e5e7eb;
    padding:.25rem .7rem;
    font-size:12px;
  }

  .mod-tools{
    display:flex;
    align-items:center;
    gap:.3rem;
  }

  .mod-detail{
    display:none;
    margin:6px 6px 8px;
  }
  .mod-detail textarea{
    width:100%;
    min-height:60px;
    border-radius:12px;
    border:1px solid rgba(55,65,81,.9);
    background:#020617;
    color:#e5e7eb;
    font-size:12px;
    padding:.4rem .55rem;
  }

  /* Steps layout 3 por fila */
  .steps{
    position:relative;
    margin-top:4px;
  }
  .steps-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:16px 18px;
    align-items:start;
  }
  @media (max-width:1180px){
    .steps-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  @media (max-width:860px){
    .steps-grid{grid-template-columns:1fr;}
  }

  .step-wrap{position:relative;}

  .step{
    position:relative;
    background:var(--stepGrad);
    border-radius:18px;
    padding:9px 10px 10px 16px;
    min-height:70px;
    box-shadow:
      0 3px 0 rgba(148,163,184,.8),
      0 12px 20px rgba(15,23,42,.35);
    border:1px solid rgba(148,163,184,.7);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .step::before{
    content:"";
    position:absolute;
    inset:0 auto 0 0;
    width:6px;
    background:var(--stepSide);
  }

  .bubble{
    min-width:22px;height:22px;border-radius:999px;
    background:radial-gradient(circle at 30% 0,#bfdbfe,#1d4ed8);
    color:#020617;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:900;
    box-shadow:0 2px 0 rgba(148,163,184,1);
    margin-bottom:4px;
  }

  .step-title{
    border:0;
    outline:0;
    background:transparent;
    font-weight:800;
    font-size:13px;
    line-height:1.25;
    color:#020617;
    padding:0;
    word-wrap:break-word;
    white-space:normal;
  }

  .step-footer{
    margin-top:6px;
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:.25rem;
  }

  .step-pencil{
    width:30px;height:30px;border-radius:999px;border:0;
    background:#020617;
    color:#e5e7eb;
    cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.4),0 2px 0 rgba(15,23,42,1);
    font-size:15px;
  }
  .step-pencil:active{transform:translateY(1px);}
  .step-menu{
    position:absolute;
    right:10px;top:8px;
    display:flex;
    gap:.25rem;
    visibility:hidden;
    opacity:0;
    transition:opacity .15s;
  }
  .step-wrap:hover .step-menu{opacity:1;visibility:visible;}
  .step-menu button{
    width:26px;height:26px;border-radius:999px;border:0;
    background:#020617;color:#e5e7eb;cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(148,163,184,.35),0 2px 0 rgba(15,23,42,1);
    font-size:13px;
  }
  .step-menu button:active{transform:translateY(1px);}

  .meta-badge{
    position:absolute;
    right:10px;
    bottom:8px;
    padding:2px 8px;
    border-radius:999px;
    background:#020617;
    color:#facc15;
    font-size:11px;
    font-weight:800;
    display:flex;
    align-items:center;
    gap:.25rem;
    box-shadow:0 2px 4px rgba(15,23,42,.9);
  }

  /* ver m√°s */
  .more-tag{
    display:inline-flex;
    align-items:center;
    gap:.25rem;
    padding:2px 8px;
    border-radius:999px;
    background:#e5e7eb;
    color:#111827;
    font-size:11px;
    font-weight:800;
    margin-top:4px;
    cursor:pointer;
    box-shadow:0 2px 3px rgba(148,163,184,.7);
    align-self:flex-start;
  }
  .more-tag span.hand{font-size:12px;}

  /* Branch panel (SI / NO) */
  .branches{
    margin-top:6px;
    border-radius:14px;
    border:1px dashed rgba(148,163,184,.9);
    background:#f9fafb;
    padding:6px 8px 7px;
    box-shadow:0 4px 10px rgba(15,23,42,.2);
  }
  .branches.compact{display:none;}

  .branch-row{
    display:flex;
    align-items:flex-start;
    gap:6px;
    margin-bottom:4px;
  }
  .branch-label{
    min-width:34px;
    font-size:11px;
    font-weight:900;
    padding:2px 6px;
    border-radius:999px;
    text-align:center;
    color:#020617;
  }
  .branch-label.yes{background:#bbf7d0;}
  .branch-label.no{background:#fed7aa;}

  .branch-body{flex:1;display:flex;align-items:center;gap:4px;}
  .branch-text{
    flex:1;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    padding:3px 8px;
    font-size:12px;
  }
  .branch-tools{
    display:flex;
    align-items:center;
    gap:4px;
  }
  .branch-tools button{
    width:22px;height:22px;border-radius:999px;border:0;
    background:#e5e7eb;color:#111827;font-size:12px;
    cursor:pointer;
  }

  .branch-chip{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:2px 8px;
    border-radius:999px;
    background:#fee2e2;
    color:#b91c1c;
    font-size:11px;
    margin-top:4px;
  }

  /* Flow arrows */
  .flow-svg{
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  .sub-link-line{
    position:absolute;
    border:1px dashed rgba(248,250,252,.65);
    border-right:none;
  }

  /* Toast */
  .pa-toast{
    position:fixed;
    right:14px;bottom:16px;
    background:#020617;
    color:#f9fafb;
    padding:.55rem .8rem;
    border-radius:10px;
    box-shadow:0 8px 20px rgba(0,0,0,.9);
    font-size:13px;
    opacity:0;
    transform:translateY(6px);
    pointer-events:none;
    transition:all .2s;
    z-index:80;
  }
  .pa-toast.show{opacity:1;transform:translateY(0);}

  /* Readonly lock */
  body.pa-locked .lock-target{
    pointer-events:none;
    opacity:.7;
  }

</style>
</head>
<body>
<div class="topbar">
  <div class="logo">
    <span class="ear">üéß</span>
    <span>PROCESOS AUDIO</span>
  </div>

  <div class="search">
    <span style="font-size:13px;opacity:.7">üîç</span>
    <input id="q" placeholder="Buscar en departamento / proceso / pasos‚Ä¶">
  </div>

  <div class="dept-wrap">
    <select id="deptSelect" class="dept-select"></select>
    <button id="btnNewDept" class="btn3d"><span class="icon">üè¢</span><small>Nuevo departamento</small></button>
  </div>

  <button id="btnPin" class="btn3d"><span>üîí</span><small>PIN</small></button>
  <button id="btnPdf" class="btn3d"><span>üìÑ</span><small>PDF</small></button>
  <button id="btnHtml" class="btn3d"><span>‚¨áÔ∏è</span><small>HTML</small></button>
  <button id="btnCloudSave" class="btn3d"><span>‚òÅÔ∏è</span><small>Nube</small></button>

  <div class="top-right">
    <span id="stamp" class="stamp">‚Äî</span>
    <button id="btnGlobalSave" class="btn3d btn3d-ghost"><span class="icon">üíæ</span><small>Guardar todo</small></button>
  </div>
</div>

<div class="layout">
  <aside class="left">
    <div id="departmentsLeft"></div>
  </aside>

  <main class="right">
    <div class="board-head">
      <div class="board-title">
        <div>
          <strong id="boardTitle">‚Äî</strong>
          <div><small id="boardDeptLabel">Audiolog√≠a</small></div>
        </div>
      </div>
      <div class="board-head-controls">
        <button id="btnAddSubprocPaso" class="pill-black lock-target">+ Sub/subproceso</button>
        <button id="btnAddStepGlobal" class="pill-black lock-target">+ Paso</button>
        <button id="btnProcessSave" class="pill-black lock-target">üíæ Guardar proceso</button>
      </div>
    </div>
    <section id="modules" class="modules"></section>
  </main>
</div>

<div id="toast" class="pa-toast"></div>

<script>
/* ==== Utils ==== */
const LSKEY='pa_v4_departamentos';
const RESPONSABLES=['Audi√≥logo','Responsable','Otros'];
const colors=['#fde68a','#bfdbfe','#bbf7d0','#fecaca','#e9d5ff','#a5b4fc','#fed7aa','#fbcfe8','#cf9fff'];
const uid=()=> 'p'+Math.random().toString(36).slice(2,11);
const stamp=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}, ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;};
const toastMsg=(msg)=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);};

/* ==== Estado ==== */
let state={departments:[],activeDeptId:null,activePid:null};
function makeEmptyStep(){
  return {id:uid(),title:'Nuevo paso',detail:'',yes:{text:'',link:null},no:{text:'',link:null},hasBranches:false,isMeta:false,link:null};
}
function makeEmptyModule(){
  return {id:uid(),title:'Nuevo subproceso',responsable:RESPONSABLES[0],detail:'',steps:[makeEmptyStep()],children:[],parentId:null};
}
function makeEmptyProcess(name,color){
  return {id:uid(),name:name||'Nuevo proceso',color:color||colors[0],detail:'',modules:[makeEmptyModule()]};
}
function makeEmptyDepartment(name){
  return {id:uid(),name:name||'Audiolog√≠a',processes:[]};
}

/* ==== Persistencia ==== */
function internalSave(){
  localStorage.setItem(LSKEY,JSON.stringify(state));
  document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+stamp();
}
function migrateIfNeeded(raw){
  if(raw.departments) return raw;
  // versi√≥n antigua: solo procesos
  const dept=makeEmptyDepartment('Audiolog√≠a');
  dept.processes = raw.processes||[];
  const s={departments:[dept],activeDeptId:dept.id,activePid:dept.processes[0]?.id||null};
  return s;
}
function load(){
  const raw=localStorage.getItem(LSKEY);
  if(raw){
    try{
      state=migrateIfNeeded(JSON.parse(raw));
    }catch(e){
      console.error(e);
      state={departments:[makeEmptyDepartment('Audiolog√≠a')],activeDeptId:null,activePid:null};
    }
  }else{
    const d=makeEmptyDepartment('Audiolog√≠a');
    d.processes.push(makeEmptyProcess('Revisi√≥n auditiva',colors[0]));
    state.departments=[d];
    state.activeDeptId=d.id;
    state.activePid=d.processes[0].id;
    internalSave();
  }
  if(!state.activeDeptId && state.departments[0]) state.activeDeptId=state.departments[0].id;
  if(!state.activePid){
    const d=getActiveDept();
    state.activePid=d.processes[0]?.id||null;
  }
}
function getActiveDept(){
  return state.departments.find(d=>d.id===state.activeDeptId) || state.departments[0];
}
function getActiveProcess(){
  const d=getActiveDept();
  return d?.processes.find(p=>p.id===state.activePid) || d?.processes[0] || null;
}

/* ==== Render LEFT (departamentos + procesos) ==== */
function renderDeptSelector(){
  const sel=document.getElementById('deptSelect');
  sel.innerHTML='';
  state.departments.forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d.id;
    opt.textContent=d.name;
    sel.appendChild(opt);
  });
  if(state.activeDeptId) sel.value=state.activeDeptId;
}
function renderLeft(){
  const box=document.getElementById('departmentsLeft');
  box.innerHTML='';
  state.departments.forEach(dept=>{
    const blk=document.createElement('div');
    blk.className='dept-block';
    const head=document.createElement('div');
    head.className='dept-head';
    const title=document.createElement('div');
    title.className='dept-title';
    title.textContent=dept.name;
    title.onclick=()=>{
      state.activeDeptId=dept.id;
      const any=dept.processes[0];
      state.activePid=any?any.id:null;
      internalSave();
      renderAll();
    };
    title.ondblclick=()=>{
      const nn=prompt('Nombre del departamento',dept.name);
      if(nn){dept.name=nn.trim()||dept.name;internalSave();renderAll();}
    };
    const tag=document.createElement('span');
    tag.className='dept-tag';
    tag.textContent='Procesos: '+dept.processes.length;
    head.appendChild(title);head.appendChild(tag);
    blk.appendChild(head);

    const plist=document.createElement('div');
    plist.className='proc-list';

    dept.processes.forEach(p=>{
      const item=document.createElement('div');
      item.className='proc-item'+(state.activePid===p.id && state.activeDeptId===dept.id?' active':'');
      const main=document.createElement('div');
      main.className='proc-main';
      const dot=document.createElement('span');
      dot.className='dot';
      dot.style.background=p.color||colors[0];
      const name=document.createElement('div');
      name.className='proc-name';
      name.textContent=p.name;
      const acts=document.createElement('div');
      acts.className='proc-actions';
      const bDet=document.createElement('button');
      bDet.className='icon-btn lock-target';
      bDet.textContent='‚úé';
      const bDel=document.createElement('button');
      bDel.className='icon-btn lock-target';
      bDel.textContent='üóë';
      const bSave=document.createElement('button');
      bSave.className='icon-btn lock-target';
      bSave.textContent='üíæ';

      main.onclick=()=>{
        state.activeDeptId=dept.id;
        state.activePid=p.id;
        internalSave();
        renderAll();
      };

      bDet.onclick=(ev)=>{
        ev.stopPropagation();
        p._openDetail=!p._openDetail;
        internalSave();
        renderAll();
      };
      bDel.onclick=(ev)=>{
        ev.stopPropagation();
        if(!confirm('¬øEliminar proceso y todos sus subprocesos y pasos?'))return;
        const idx=dept.processes.findIndex(x=>x.id===p.id);
        if(idx>-1) dept.processes.splice(idx,1);
        if(state.activePid===p.id) state.activePid=dept.processes[0]?.id||null;
        internalSave();
        renderAll();
      };
      bSave.onclick=(ev)=>{
        ev.stopPropagation();
        internalSave();
        toastMsg('Proceso guardado');
      };

      acts.appendChild(bSave);
      acts.appendChild(bDet);
      acts.appendChild(bDel);
      main.appendChild(dot);main.appendChild(name);main.appendChild(acts);
      item.appendChild(main);

      const det=document.createElement('div');
      det.className='proc-detail';
      if(p._openDetail) det.style.display='block';
      const ta=document.createElement('textarea');
      ta.value=p.detail||'';
      ta.oninput=e=>{p.detail=e.target.value;};
      ta.onblur=()=>{internalSave();};
      det.appendChild(ta);
      item.appendChild(det);

      plist.appendChild(item);
    });

    const addP=document.createElement('button');
    addP.className='pill-black lock-target';
    addP.style.margin='4px .45rem 2px';
    addP.textContent='+ Proceso';
    addP.onclick=()=>{
      const color=colors[dept.processes.length%colors.length];
      const p=makeEmptyProcess('Nuevo proceso',color);
      dept.processes.push(p);
      state.activeDeptId=dept.id;
      state.activePid=p.id;
      internalSave();
      renderAll();
    };

    blk.appendChild(plist);
    blk.appendChild(addP);
    box.appendChild(blk);
  });
}

/* ==== Render RIGHT (m√≥dulos y pasos) ==== */
function stepHasExtra(st){
  return (st.detail && st.detail.trim()) ||
         (st.hasBranches && ((st.yes?.text||'').trim() || (st.no?.text||'').trim())) ||
         st.link;
}
function renderBranches(st,wrap,p){
  const branches=document.createElement('div');
  branches.className='branches lock-target';
  if(!st.hasBranches) branches.style.display='none';

  const yesRow=document.createElement('div');
  yesRow.className='branch-row';
  const yesLabel=document.createElement('div');
  yesLabel.className='branch-label yes';
  yesLabel.textContent='S√ç';
  const yesBody=document.createElement('div');
  yesBody.className='branch-body';
  const yesInput=document.createElement('input');
  yesInput.className='branch-text';
  yesInput.placeholder='Opciones S√ç‚Ä¶';
  yesInput.value=st.yes?.text||'';
  yesInput.oninput=e=>{st.yes=st.yes||{};st.yes.text=e.target.value;};
  yesInput.onblur=()=>internalSave();
  const yesTools=document.createElement('div');
  yesTools.className='branch-tools';
  const yesLink=document.createElement('button');
  yesLink.textContent='üîó';
  yesLink.title='Ir a pr√≥ximo proceso (S√ç)';
  yesLink.onclick=()=>{
    const d=getActiveDept();
    const list=d.processes.map(pr=>`${pr.name} (${pr.id})`).join('\n');
    const pid=prompt('ID de proceso destino S√ç.\n\n'+list,st.yes?.pid||'');
    if(!pid)return;
    st.yes=st.yes||{};
    st.yes.pid=pid;
    internalSave();
    renderAll();
  };
  yesTools.appendChild(yesLink);
  yesBody.appendChild(yesInput);yesBody.appendChild(yesTools);
  yesRow.appendChild(yesLabel);yesRow.appendChild(yesBody);

  const noRow=document.createElement('div');
  noRow.className='branch-row';
  const noLabel=document.createElement('div');
  noLabel.className='branch-label no';
  noLabel.textContent='NO';
  const noBody=document.createElement('div');
  noBody.className='branch-body';
  const noInput=document.createElement('input');
  noInput.className='branch-text';
  noInput.placeholder='Opciones NO‚Ä¶';
  noInput.value=st.no?.text||'';
  noInput.oninput=e=>{st.no=st.no||{};st.no.text=e.target.value;};
  noInput.onblur=()=>internalSave();
  const noTools=document.createElement('div');
  noTools.className='branch-tools';
  const noLink=document.createElement('button');
  noLink.textContent='üîó';
  noLink.title='Ir a pr√≥ximo proceso (NO)';
  noLink.onclick=()=>{
    const d=getActiveDept();
    const list=d.processes.map(pr=>`${pr.name} (${pr.id})`).join('\n');
    const pid=prompt('ID de proceso destino NO.\n\n'+list,st.no?.pid||'');
    if(!pid)return;
    st.no=st.no||{};
    st.no.pid=pid;
    internalSave();
    renderAll();
  };
  noTools.appendChild(noLink);
  noBody.appendChild(noInput);noBody.appendChild(noTools);
  noRow.appendChild(noLabel);noRow.appendChild(noBody);

  branches.appendChild(yesRow);
  branches.appendChild(noRow);

  // etiqueta destino de proceso
  if(st.yes?.pid || st.no?.pid){
    const chip=document.createElement('div');
    chip.className='branch-chip';
    chip.innerHTML='‚û° Pr√≥ximo proceso';
    branches.appendChild(chip);
  }

  wrap.appendChild(branches);
  return branches;
}

function renderStepsForModule(m,p,container){
  const grid=document.createElement('div');
  grid.className='steps-grid';

  m.steps.forEach((st,idx)=>{
    const wrap=document.createElement('div');
    wrap.className='step-wrap';

    const step=document.createElement('div');
    step.className='step lock-target';
    step.style.setProperty('--stepSide',p.color||colors[0]);
    const b=document.createElement('div');
    b.className='bubble';
    b.textContent=idx+1;
    step.appendChild(b);

    const title=document.createElement('textarea');
    title.className='step-title';
    title.value=st.title||'Nuevo paso';
    title.oninput=e=>{st.title=e.target.value;};
    title.onblur=()=>internalSave();
    step.appendChild(title);

    if(st.isMeta){
      const meta=document.createElement('div');
      meta.className='meta-badge';
      meta.innerHTML='üéØ META';
      step.appendChild(meta);
    }

    const menu=document.createElement('div');
    menu.className='step-menu';
    const btnPlay=document.createElement('button');
    btnPlay.textContent='‚ñ∂';
    const btnInfo=document.createElement('button');
    btnInfo.textContent='?';
    const btnAttach=document.createElement('button');
    btnAttach.textContent='üìé';
    const btnDel=document.createElement('button');
    btnDel.textContent='üóë';

    btnAttach.onclick=(ev)=>{
      ev.stopPropagation();
      const url=prompt('Enlace o referencia para este paso',st.link||'');
      if(url!==null){st.link=url.trim()||null;internalSave();renderAll();}
    };
    btnDel.onclick=(ev)=>{
      ev.stopPropagation();
      if(!confirm('¬øEliminar paso?'))return;
      const i=m.steps.findIndex(x=>x.id===st.id);
      if(i>-1){m.steps.splice(i,1);internalSave();renderAll();}
    };
    btnInfo.onclick=(ev)=>{
      ev.stopPropagation();
      st.detail=st.detail||'';
      const txt=prompt('Detalle r√°pido del paso',st.detail);
      if(txt!==null){st.detail=txt;internalSave();renderAll();}
    };
    btnPlay.onclick=ev=>{ev.stopPropagation();toastMsg('Narrar paso (futuro agente avatar)');};

    menu.appendChild(btnPlay);
    menu.appendChild(btnInfo);
    menu.appendChild(btnAttach);
    menu.appendChild(btnDel);
    step.appendChild(menu);

    // Fald√≥n ver m√°s + detalle y SI/NO
    let branchesEl=null;
    if(stepHasExtra(st)){
      const more=document.createElement('div');
      more.className='more-tag lock-target';
      more.innerHTML='<strong>ver m√°s</strong> <span class="hand">üëá</span>';
      more.onclick=()=>{
        st._open=!st._open;
        internalSave();
        renderAll();
      };
      step.appendChild(more);
    }else{
      // al pulsar l√°piz detalle se activar√°n ramas/detalle
    }

    const detailHolder=document.createElement('div');
    detailHolder.style.marginTop='4px';
    if(st._open){
      const ta=document.createElement('textarea');
      ta.className='step-title';
      ta.style.fontWeight='600';
      ta.style.fontSize='12px';
      ta.style.minHeight='46px';
      ta.placeholder='Detalle del paso‚Ä¶';
      ta.value=st.detail||'';
      ta.oninput=e=>{st.detail=e.target.value;};
      ta.onblur=()=>internalSave();
      detailHolder.appendChild(ta);
    }
    step.appendChild(detailHolder);

    branchesEl = renderBranches(st,step,p);
    if(!st._open) branchesEl.classList.add('compact'); else branchesEl.classList.remove('compact');

    const footer=document.createElement('div');
    footer.className='step-footer';
    const pencil=document.createElement('button');
    pencil.className='step-pencil';
    pencil.textContent='‚úèÔ∏è';
    pencil.onclick=()=>{
      st._open=!st._open;
      st.hasBranches=true;
      internalSave();
      renderAll();
    };
    footer.appendChild(pencil);
    step.appendChild(footer);

    wrap.appendChild(step);
    grid.appendChild(wrap);
  });

  container.appendChild(grid);
}

/* eliminar subproceso + hijos */
function deleteModuleCascade(p,mId){
  const idx=p.modules.findIndex(x=>x.id===mId);
  if(idx===-1)return;
  p.modules.splice(idx,1);
  // children ya est√°n dentro de modules con parentId, simplemente filtrados
  p.modules = p.modules.filter(x=>x.parentId!==mId);
}

/* render de cada m√≥dulo (subproceso) */
function renderModule(p,m,parent){
  const card=document.createElement('div');
  card.className='module';
  if(m.parentId) card.classList.add('sub-child');

  const head=document.createElement('div');
  head.className='mod-head';

  const title=document.createElement('input');
  title.className='mod-title lock-target';
  title.value=m.title||'Nuevo subproceso';
  title.oninput=e=>{m.title=e.target.value;};
  title.onblur=()=>internalSave();

  const selResp=document.createElement('select');
  selResp.className='mod-select lock-target';
  RESPONSABLES.forEach(r=>{
    const o=document.createElement('option');
    o.value=r;o.textContent=r;
    if(m.responsable===r)o.selected=true;
    selResp.appendChild(o);
  });
  selResp.onchange=e=>{
    m.responsable=e.target.value;
    if(m.responsable==='Otros'){
      const n=prompt('Nombre de la persona responsable','');
      if(n) m.responsable='Otros: '+n;
    }
    internalSave();
    renderAll();
  };

  const tools=document.createElement('div');
  tools.className='mod-tools';
  const bDet=document.createElement('button');
  bDet.className='pill-black lock-target';
  bDet.textContent='Detalle';
  const bSteps=document.createElement('button');
  bSteps.className='pill-black lock-target';
  bSteps.textContent='+ Paso';
  const bSub=document.createElement('button');
  bSub.className='pill-black lock-target';
  bSub.textContent='+ Sub/subproceso';
  const bSave=document.createElement('button');
  bSave.className='pill-black lock-target';
  bSave.textContent='üíæ';
  const bDel=document.createElement('button');
  bDel.className='pill-black lock-target';
  bDel.textContent='‚Äì';

  bDet.onclick=()=>{
    m._openDetail=!m._openDetail;
    internalSave();
    renderAll();
  };
  bSteps.onclick=()=>{
    m.steps.push(makeEmptyStep());
    internalSave();
    renderAll();
  };
  bSub.onclick=()=>{
    const child=makeEmptyModule();
    child.title=m.title+' - Sub';
    child.parentId=m.id;
    p.modules.push(child);
    internalSave();
    renderAll();
  };
  bSave.onclick=()=>{internalSave();toastMsg('Subproceso guardado');};
  bDel.onclick=()=>{
    if(!confirm('¬øEliminar subproceso y sus pasos/sub-subprocesos?'))return;
    deleteModuleCascade(p,m.id);
    internalSave();
    renderAll();
  };

  tools.appendChild(bDet);
  tools.appendChild(bSteps);
  tools.appendChild(bSub);
  tools.appendChild(bSave);
  tools.appendChild(bDel);

  head.appendChild(title);
  head.appendChild(selResp);
  head.appendChild(tools);
  card.appendChild(head);

  const det=document.createElement('div');
  det.className='mod-detail';
  if(m._openDetail) det.style.display='block';
  const ta=document.createElement('textarea');
  ta.value=m.detail||'';
  ta.oninput=e=>{m.detail=e.target.value;};
  ta.onblur=()=>internalSave();
  det.appendChild(ta);
  card.appendChild(det);

  const stepsBox=document.createElement('div');
  stepsBox.className='steps';
  renderStepsForModule(m,p,stepsBox);
  card.appendChild(stepsBox);

  parent.appendChild(card);
}

function renderRight(){
  const mods=document.getElementById('modules');
  mods.innerHTML='';
  const p=getActiveProcess();
  const dept=getActiveDept();
  document.getElementById('boardTitle').textContent=p?`${p.name} - Pasos`:'Sin proceso';
  document.getElementById('boardDeptLabel').textContent=dept?dept.name:'‚Äî';
  if(!p) return;
  p.modules.forEach(m=>{
    if(m.parentId) return; // se pintan despu√©s
    renderModule(p,m,mods);
    // hijos sub-sub
    p.modules.filter(ch=>ch.parentId===m.id).forEach(ch=>{
      const subWrap=document.createElement('div');
      subWrap.style.position='relative';
      const subCard=document.createElement('div');
      subCard.className='module sub-child';
      // l√≠nea discontinua de panel a panel
      const line=document.createElement('div');
      line.className='sub-link-line';
      // se posicionar√° luego con resizeObserver simple
      mods.appendChild(line);
      renderModule(p,ch,mods);
    });
  });
}

/* ==== Render maestro ==== */
function renderAll(){
  renderDeptSelector();
  renderLeft();
  renderRight();
}

/* ==== Acciones globales ==== */
document.getElementById('btnAddStepGlobal').onclick=()=>{
  const p=getActiveProcess();if(!p)return;
  let m=p.modules.find(x=>!x.parentId) || p.modules[0];
  if(!m){m=makeEmptyModule();p.modules.push(m);}
  m.steps.push(makeEmptyStep());
  internalSave();renderAll();
};
document.getElementById('btnAddSubprocPaso').onclick=()=>{
  const p=getActiveProcess();if(!p)return;
  const m=makeEmptyModule();
  p.modules.push(m);
  internalSave();renderAll();
};
document.getElementById('btnProcessSave').onclick=()=>{internalSave();toastMsg('Proceso guardado');};
document.getElementById('btnGlobalSave').onclick=()=>{internalSave();toastMsg('Todo guardado');};

document.getElementById('btnNewDept').onclick=()=>{
  const name=prompt('Nombre del nuevo departamento','Nuevo departamento');
  const d=makeEmptyDepartment(name||'Nuevo departamento');
  state.departments.push(d);
  state.activeDeptId=d.id;
  state.activePid=null;
  internalSave();
  renderAll();
};

document.getElementById('deptSelect').onchange=e=>{
  const id=e.target.value;
  state.activeDeptId=id;
  const d=getActiveDept();
  state.activePid=d.processes[0]?.id||null;
  internalSave();
  renderAll();
};

/* Buscador simple */
document.getElementById('q').addEventListener('input',e=>{
  const q=e.target.value.trim().toLowerCase();
  const d=getActiveDept();if(!d)return;
  if(!q){renderAll();return;}
  // filtrado simple de procesos cuyo nombre o pasos contengan el texto
  const filtered=d.processes.filter(p=>{
    if((p.name||'').toLowerCase().includes(q))return true;
    if((p.detail||'').toLowerCase().includes(q))return true;
    for(const m of p.modules||[]){
      if((m.title||'').toLowerCase().includes(q))return true;
      for(const st of m.steps||[]){
        if((st.title||'').toLowerCase().includes(q))return true;
        if((st.detail||'').toLowerCase().includes(q))return true;
      }
    }
    return false;
  });
  const left=document.getElementById('departmentsLeft');
  left.querySelectorAll('.dept-block').forEach((blk,i)=>{
    const dept=state.departments[i];
    if(dept.id!==d.id)return;
    const plist=blk.querySelector('.proc-list');
    plist.innerHTML='';
    filtered.forEach(p=>{
      const fakeDept={processes:filtered};
      state.activePid=state.activePid&&filtered.find(x=>x.id===state.activePid)?state.activePid:filtered[0]?.id||null;
      renderLeft();
    });
  });
});

/* PIN lectura (solo deshabilita edici√≥n, pero se ve todo) */
document.getElementById('btnPin').onclick=()=>{
  const locked=document.body.classList.toggle('pa-locked');
  toastMsg(locked?'Modo lectura: no editable':'Edici√≥n habilitada');
};

/* PDF / HTML / Nube: versiones simples para evitar 404 */
document.getElementById('btnPdf').onclick=()=>{window.print();};
document.getElementById('btnHtml').onclick=()=>{
  const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='PROCESOS-AUDIO.html';
  a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('btnCloudSave').onclick=()=>{
  try{
    localStorage.setItem(LSKEY+'_SNAP',JSON.stringify(state));
    toastMsg('Copia guardada en nube local');
  }catch(e){toastMsg('No se pudo guardar');}
};

/* ==== Inicio ==== */
load();
document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+stamp();
renderAll();
</script>
</body>
</html>

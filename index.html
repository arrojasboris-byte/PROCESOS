<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PROCESOS AUDIO</title>
<style>
:root{
  --bg:#e5e7eb;
  --main-bg:#ffffff;
  --ink:#111827;
  --muted:#6b7280;

  --top-grad:linear-gradient(90deg,#7b1f1f 0%,#b91c1c 45%,#7b1f1f 100%);

  --panel-dark:#111827;
  --panel-dark-soft:#020617;

  --card:#ffffff;

  --accent:#ef4444;
  --accent-soft:#fecaca;

  --shadow-soft:0 10px 24px rgba(15,23,42,.25);
  --shadow-card:0 6px 16px rgba(15,23,42,.28);
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  font-size:14px;
  background:var(--bg);
  color:var(--ink);
}

/* =================== TOPBAR =================== */
.topbar{
  position:sticky;top:0;z-index:50;
  display:flex;align-items:center;gap:.75rem;
  padding:.45rem .9rem .55rem;
  background:var(--top-grad);
  color:#fff;
  box-shadow:0 10px 24px rgba(0,0,0,.4);
}
.logo{
  display:flex;align-items:center;gap:.55rem;
  font-size:22px;font-weight:900;letter-spacing:.03em;
}
.logo .ear{font-size:30px;line-height:1}
.top-actions{
  display:flex;align-items:center;gap:.45rem;
  margin-left:auto;
}

/* Botones 3D rojos peque√±os y alineados */
.btn3d{
  display:inline-flex;align-items:center;gap:.3rem;
  padding:.35rem .75rem;
  border-radius:9999px;
  border:none;
  background:#ef4444;
  color:#fff;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.55),
    0 3px 0 rgba(127,29,29,.9),
    0 10px 18px rgba(0,0,0,.45);
}
.btn3d span.icon{font-size:15px}
.btn3d:active{
  transform:translateY(1px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.45),
    0 1px 0 rgba(127,29,29,.9),
    0 6px 10px rgba(0,0,0,.45);
}

.stamp{
  font-size:12px;
  padding:.2rem .65rem;
  border-radius:9999px;
  background:rgba(0,0,0,.28);
}

/* buscador global */
.searchbar-wrap{
  padding:.35rem .8rem .55rem;
  background:#f9fafb;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.searchbar{
  display:flex;align-items:center;
  padding:.45rem .7rem;
  border-radius:9999px;
  background:#e5e7eb;
}
.searchbar input{
  flex:1;border:none;background:transparent;outline:none;
  font-weight:600;color:#374151;
}

/* =================== LAYOUT =================== */
.app{
  display:grid;
  grid-template-columns:320px 1fr;
  min-height:calc(100vh - 96px);
}
.sidebar{
  background:#0b1120;
  color:#e5e7eb;
  padding:.8rem .7rem 1.2rem;
  box-shadow:4px 0 18px rgba(0,0,0,.55);
  overflow-y:auto;
}
.main{
  background:var(--main-bg);
  padding:.8rem 1rem 1.2rem 1rem;
  overflow:auto;
}

/* =================== SIDEBAR =================== */
.dept-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:.4rem;
  font-weight:800;font-size:15px;
}
.dept-header small{font-size:11px;opacity:.7}

.dept-block{
  margin-bottom:1rem;
  border-top:1px solid rgba(148,163,184,.5);
  padding-top:.6rem;
}
.dept-title-row{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:.4rem;
}
.dept-title-row strong{font-size:14px}
.dept-title-row button{
  background:#020617;border-radius:999px;border:none;color:#e5e7eb;
  padding:.15rem .45rem;font-size:11px;cursor:pointer;
}

.proc-list{display:flex;flex-direction:column;gap:.3rem}
.proc-item{
  display:flex;align-items:center;gap:.5rem;
  padding:.45rem .6rem;
  border-radius:12px;
  background:#020617;
  box-shadow:0 1px 0 rgba(255,255,255,.06),0 4px 10px rgba(0,0,0,.5);
  cursor:pointer;
}
.proc-item.active{
  outline:2px solid var(--accent-soft);
  box-shadow:0 0 0 1px rgba(248,250,252,.4),0 4px 14px rgba(0,0,0,.75);
}
.proc-dot{
  width:10px;height:10px;border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 2px rgba(15,23,42,.8);
}
.proc-name{flex:1;font-weight:700;font-size:13px}
.proc-acts{display:flex;align-items:center;gap:.25rem}
.icon-pill{
  width:26px;height:26px;border-radius:999px;
  border:none;cursor:pointer;
  background:#111827;color:#e5e7eb;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;
  box-shadow:0 2px 5px rgba(0,0,0,.65);
}
.icon-pill:active{transform:translateY(1px)}

/* =================== CABECERA PROCESO =================== */
.proc-header{
  background:var(--panel-dark);
  color:#f9fafb;
  border-radius:14px;
  padding:.6rem .9rem;
  box-shadow:var(--shadow-soft);
  margin-bottom:.8rem;
  display:flex;align-items:center;gap:.7rem;
}
.proc-header h1{
  font-size:18px;font-weight:900;margin-right:.6rem;
}
.proc-header small{font-size:11px;opacity:.7}
.proc-header-right{
  margin-left:auto;
  display:flex;align-items:center;gap:.4rem;
}
.proc-header-right select{
  border-radius:999px;border:none;
  padding:.25rem .7rem;
  font-size:13px;
}

/* =================== SUBPROCESOS =================== */
.sub-block{
  position:relative;
  margin-bottom:1.2rem;
  border-radius:14px;
  background:#ffffff;                  /* FONDO BLANCO */
  border:1px solid #e5e7eb;
  box-shadow:0 6px 16px rgba(15,23,42,.18);
}
.sub-head{
  display:flex;align-items:center;gap:.6rem;
  padding:.5rem .8rem;
  border-radius:14px 14px 0 0;
  background:var(--panel-dark);
  color:#f9fafb;
  font-weight:800;
}
.sub-head-title{flex:1}
.sub-head select{
  border-radius:999px;border:none;
  padding:.2rem .6rem;
  font-size:13px;
}
.sub-head .head-actions{
  display:flex;align-items:center;gap:.35rem;
}
.badge-save{
  display:inline-flex;align-items:center;gap:.25rem;
  padding:.25rem .6rem;
  border-radius:9999px;
  background:#0b1120;
  color:#f9fafb;
  font-size:12px;
}
.badge-save span.icon{font-size:13px}

/* SUB-SUBPROCESO, m√°s peque√±o, blanco */
.sub-child{
  position:relative;
  margin:.75rem .9rem .9rem .9rem;
  border-radius:12px;
  background:#ffffff;                    /* BLANCO */
  border:1px dashed rgba(148,163,184,.9);
  box-shadow:0 4px 12px rgba(15,23,42,.18);
}
.sub-child-head{
  display:flex;align-items:center;gap:.6rem;
  padding:.45rem .75rem;
  border-radius:12px 12px 0 0;
  background:#1f2937;
  color:#f9fafb;
  font-weight:800;
}
.sub-child .badge-save{background:#020617}

/* l√≠nea discontinua desde fald√≥n padre hasta fald√≥n hijo */
.sub-child::before{
  content:"";
  position:absolute;
  top:-18px;left:40px;
  width:0;height:18px;
  border-left:2px dashed rgba(148,163,184,.95);
}
.sub-child::after{
  content:"";
  position:absolute;
  top:-4px;left:34px;
  width:12px;height:12px;
  border-right:2px dashed rgba(148,163,184,.95);
  border-bottom:2px dashed rgba(148,163,184,.95);
  transform:rotate(45deg);
}

/* =================== STEPS =================== */
.steps-area{
  position:relative;
  padding:.7rem .9rem 1.1rem .9rem;
}

/* ahora layout manual serpentina, no grid */
.steps-grid{
  position:relative;
  min-height:120px;
}
.step-wrap{
  position:absolute;          /* colocado por JS */
  padding-bottom:18px;
}

/* tarjeta de paso */
.step-card{
  position:relative;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow-card);
  padding:.6rem .65rem .7rem .65rem;
  border:1px solid rgba(148,163,184,.7);
}
.step-strip{
  position:absolute;
  inset:0 auto 0 0;
  width:10px;
  border-radius:16px 0 0 16px;
  background:#fde68a; /* se sobrescribe por proceso */
}

/* n√∫mero circular */
.step-badge{
  position:relative;
  z-index:2;
  width:26px;height:26px;
  border-radius:999px;
  background:#e5e7eb;  /* color por proceso en JS */
  box-shadow:0 3px 6px rgba(15,23,42,.45);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:13px;
  color:#111827;
  margin-bottom:.25rem;
}

/* t√≠tulo del paso: multilinea, no crece a lo ancho */
.step-title{
  position:relative;
  z-index:2;
  font-weight:800;
  font-size:14px;
  line-height:1.25;
  margin-right:40px;
  word-wrap:break-word;
}
.step-title[contenteditable="true"]{outline:none}

/* l√°piz flotante */
.step-edit{
  position:absolute;
  right:10px;bottom:10px;
  width:32px;height:32px;
  border-radius:999px;
  border:none;
  background:#111827;
  color:#f97316;
  display:flex;align-items:center;justify-content:center;
  font-size:15px;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,.55);
}
.step-edit:active{transform:translateY(1px)}

/* men√∫ del l√°piz */
.edit-menu{
  position:absolute;
  right:6px;bottom:50px;
  padding:.25rem .35rem;
  border-radius:9999px;
  background:#020617;
  display:flex;align-items:center;gap:.25rem;
  box-shadow:0 6px 16px rgba(0,0,0,.8);
}
.edit-menu button{
  width:26px;height:26px;
  border-radius:999px;
  border:none;
  background:#111827;
  color:#e5e7eb;
  font-size:13px;
  cursor:pointer;
}
.edit-menu button:active{transform:translateY(1px)}

/* pill ver m√°s */
.more-pill{
  position:absolute;
  left:50%;transform:translateX(-50%);
  bottom:0;
  padding:.1rem .55rem;
  font-size:11px;
  border-radius:999px;
  background:#e5e7eb;
  color:#111827;
  display:inline-flex;align-items:center;gap:.25rem;
  cursor:pointer;
  box-shadow:0 2px 5px rgba(0,0,0,.35);
}
.more-pill strong{font-weight:800}
.more-pill .hand{font-size:13px}

/* bloque detalle S√ç/NO */
.step-detail{
  margin-top:.55rem;
  padding:.4rem .45rem .5rem;
  border-radius:12px;
  background:#fefce8;
  border:1px dashed #e5e7eb;
  display:none;
}
.step-detail.open{display:block;}

.sn-row{display:flex;gap:.45rem;margin-bottom:.35rem}
.sn-col{
  flex:1;
  background:#fff;
  border-radius:10px;
  padding:.3rem .35rem .45rem;
  box-shadow:inset 0 1px 0 #f9fafb;
}
.sn-col h4{
  font-size:12px;
  font-weight:800;
  margin-bottom:.2rem;
}
.sn-col textarea{
  width:100%;min-height:40px;
  border-radius:8px;
  border:1px solid #e5e7eb;
  padding:.25rem .35rem;
  resize:vertical;
  font-size:12px;
}

.next-proc{
  margin-top:.25rem;
  font-size:11px;
  font-weight:700;
}

/* =================== FLECHAS ENTRE PASOS =================== */
.flow-svg{
  position:absolute;
  inset:0;
  pointer-events:none;
  overflow:visible;
}

/* =================== PIN LECTURA =================== */
body.pa-locked .lock-block{pointer-events:none;opacity:.55}
body.pa-locked [contenteditable]{pointer-events:none}
body.pa-locked textarea{pointer-events:none}
body.pa-locked .edit-menu{display:none!important}

/* TOAST */
.pa-toast{
  position:fixed;right:16px;bottom:18px;
  padding:.55rem .75rem;
  border-radius:10px;
  background:#111827;
  color:#f9fafb;
  box-shadow:0 8px 18px rgba(0,0,0,.55);
  opacity:0;transform:translateY(6px);
  transition:.18s;
  font-size:13px;
  z-index:9999;
}
.pa-toast.show{opacity:1;transform:translateY(0)}

@media (max-width:1024px){
  .app{grid-template-columns:260px 1fr}
}
@media (max-width:820px){
  .app{grid-template-columns:1fr}
  .sidebar{order:2}
  .main{order:1}
}
</style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="logo"><span class="ear">üéß</span> PROCESOS AUDIO</div>
    <div class="top-actions">
      <button id="btnNewDept" class="btn3d"><span class="icon">üè¢</span>Nuevo departamento</button>
      <button id="btnPin" class="btn3d"><span class="icon">üîí</span>PIN</button>
      <button id="btnPdf" class="btn3d"><span class="icon">üìÑ</span>PDF</button>
      <button id="btnHtml" class="btn3d"><span class="icon">‚¨áÔ∏è</span>HTML</button>
      <button id="btnCloudSave" class="btn3d"><span class="icon">‚òÅÔ∏è</span>Nube</button>
      <span id="stamp" class="stamp">‚Äî</span>
      <button id="btnGlobalSave" class="btn3d"><span class="icon">üíæ</span>Guardar todo</button>
    </div>
  </div>

  <!-- BUSCADOR -->
  <div class="searchbar-wrap">
    <div class="searchbar">
      <input id="globalSearch" placeholder="Buscar departamento, proceso, subproceso, paso‚Ä¶">
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="app">
    <aside class="sidebar">
      <div class="dept-header">
        <span>Departamentos</span>
        <small>Selecciona para ver sus procesos</small>
      </div>
      <div id="deptContainer"></div>
    </aside>

    <main class="main">
      <div id="procHeader"></div>
      <div id="subContainer"></div>
    </main>
  </div>

  <div id="toast" class="pa-toast"></div>

<script>
/* ======= UTILIDADES ======= */
const LSKEY='pa_departamentos_v1';
const PIN_CODE='AR4321';

const PROC_COLORS=[
  '#fee2e2','#ffedd5','#fef3c7',
  '#dcfce7','#bfdbfe','#e0e7ff',
  '#fce7f3','#e0f2fe'
];
let procColorIndex=0;

const uid=()=> 'id'+Math.random().toString(36).slice(2,9);
const nowStamp=()=>{
  const d=new Date(),p=n=>String(n).padStart(2,'0');
  return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}, ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
};
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2300);
}

/* ======= ESTADO ======= */
const state={depts:[],activeDeptId:null,activeProcId:null};

function defaultDept(){
  return {id:uid(),name:'Audiolog√≠a',processes:[]};
}
function defaultProcess(name){
  const color=PROC_COLORS[procColorIndex++ % PROC_COLORS.length];
  return {id:uid(),name:name||'Nuevo proceso',detail:'',color,modules:[]};
}
function defaultModule(isChild=false){
  return {
    id:uid(),
    title:isChild?'Nuevo subproceso - Sub':'Nuevo subproceso',
    owner:'Audi√≥logo',
    detail:'',
    steps:[],
    children:[]
  };
}
function defaultStep(){
  return{ id:uid(),title:'Nuevo paso',detail:'',yes:'',no:'',collapsedDetail:true };
}

/* ======= PERSISTENCIA ======= */
function saveState(){
  localStorage.setItem(LSKEY,JSON.stringify(state));
  document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+nowStamp();
}
function loadState(){
  const raw=localStorage.getItem(LSKEY);
  if(raw){
    try{Object.assign(state,JSON.parse(raw));}catch(e){console.error(e);}
  }
  if(!state.depts.length){
    const d=defaultDept();
    const p=defaultProcess('Revisi√≥n auditiva');
    const m=defaultModule(false);
    m.steps.push(defaultStep(),defaultStep(),defaultStep(),defaultStep());
    p.modules.push(m);
    d.processes.push(p);
    state.depts.push(d);
    state.activeDeptId=d.id;
    state.activeProcId=p.id;
  }

  /* asegurar colores pastel para procesos antiguos */
  state.depts.forEach(dept=>{
    dept.processes.forEach(proc=>{
      if(!proc.color){
        proc.color=PROC_COLORS[procColorIndex++ % PROC_COLORS.length];
      }
    });
  });

  if(!state.activeDeptId && state.depts[0]) state.activeDeptId=state.depts[0].id;
  const dept=state.depts.find(x=>x.id===state.activeDeptId);
  if(dept && !state.activeProcId && dept.processes[0]) state.activeProcId=dept.processes[0].id;
}

/* ======= SIDEBAR ======= */
function renderSidebar(){
  const wrap=document.getElementById('deptContainer');
  wrap.innerHTML='';
  state.depts.forEach(dept=>{
    const block=document.createElement('div');
    block.className='dept-block';

    const title=document.createElement('div');
    title.className='dept-title-row';
    title.innerHTML=`<strong>${dept.name}</strong>
      <button data-dept="${dept.id}">Procesos (${dept.processes.length}) +</button>`;
    title.querySelector('button').onclick=()=>{
      const p=defaultProcess('Nuevo proceso');
      dept.processes.push(p);
      state.activeDeptId=dept.id;
      state.activeProcId=p.id;
      saveState();renderAll();
    };
    block.appendChild(title);

    const list=document.createElement('div');
    list.className='proc-list';
    dept.processes.forEach(proc=>{
      const item=document.createElement('div');
      item.className='proc-item'+(proc.id===state.activeProcId?' active':'');
      item.onclick=()=>{state.activeDeptId=dept.id;state.activeProcId=proc.id;renderAll();};
      item.innerHTML=`
        <span class="proc-dot" style="background:${proc.color||'#a5b4fc'}"></span>
        <span class="proc-name">${proc.name}</span>
        <div class="proc-acts">
          <button class="icon-pill" title="Guardar">üíæ</button>
          <button class="icon-pill" title="Renombrar">‚úèÔ∏è</button>
          <button class="icon-pill" title="Eliminar">üóë</button>
        </div>`;
      const [bSave,bRen,bDel]=item.querySelectorAll('.icon-pill');
      bSave.onclick=e=>{e.stopPropagation();saveState();toast('Proceso guardado');};
      bRen.onclick=e=>{
        e.stopPropagation();
        const nn=prompt('Nombre del proceso',proc.name);
        if(nn){proc.name=nn;saveState();renderAll();}
      };
      bDel.onclick=e=>{
        e.stopPropagation();
        if(!confirm('¬øEliminar proceso y todos sus subprocesos y pasos?'))return;
        dept.processes=dept.processes.filter(p=>p.id!==proc.id);
        if(dept.processes[0]) state.activeProcId=dept.processes[0].id; else state.activeProcId=null;
        saveState();renderAll();
      };
      list.appendChild(item);
    });
    block.appendChild(list);
    wrap.appendChild(block);
  });
}

/* ======= HELPERS ======= */
function getActive(){
  const dept=state.depts.find(d=>d.id===state.activeDeptId)||state.depts[0];
  const proc=dept?dept.processes.find(p=>p.id===state.activeProcId)||dept.processes[0]:null;
  if(dept && proc){state.activeDeptId=dept.id;state.activeProcId=proc.id;}
  return {dept,proc};
}

/* ======= CABECERA PROCESO ======= */
function renderProcHeader(){
  const {dept,proc}=getActive();
  const wrap=document.getElementById('procHeader');
  wrap.innerHTML='';
  if(!dept||!proc)return;

  const box=document.createElement('div');
  box.className='proc-header';
  box.innerHTML=`
    <h1>${proc.name} - Pasos</h1>
    <small>${dept.name}</small>
    <div class="proc-header-right">
      <select id="selOwner">
        <option>Audi√≥logo</option>
        <option>Responsable</option>
        <option>Otros</option>
      </select>
      <button id="btnAddModule" class="btn3d" style="transform:scale(.8)"><span class="icon">‚ûï</span>Subproceso</button>
      <button id="btnAddStepGlobal" class="btn3d" style="transform:scale(.8)"><span class="icon">‚ûï</span>Paso</button>
      <button id="btnProcSave" class="btn3d" style="transform:scale(.8)"><span class="icon">üéØ</span>Guardar proceso</button>
    </div>`;
  wrap.appendChild(box);

  document.getElementById('btnAddModule').onclick=()=>{
    proc.modules.push(defaultModule(false));
    saveState();renderSubprocs();
  };
  document.getElementById('btnAddStepGlobal').onclick=()=>{
    if(!proc.modules.length)proc.modules.push(defaultModule(false));
    const m=proc.modules[proc.modules.length-1];
    m.steps.push(defaultStep());
    saveState();renderSubprocs();
  };
  document.getElementById('btnProcSave').onclick=()=>{saveState();toast('Proceso guardado');};
}

/* ======= SUBPROCESOS / SUB-SUBPROCESOS ======= */
function renderSubprocs(){
  const {proc}=getActive();
  const container=document.getElementById('subContainer');
  container.innerHTML='';
  if(!proc)return;

  proc.modules.forEach(mod=>{
    container.appendChild(buildModule(mod,false,proc));
  });

  requestAnimationFrame(()=>{
    layoutAllSteps();
    drawAllFlows();
  });
}

function buildModule(mod,isChild,proc){
  const block=document.createElement('div');
  block.className=isChild?'sub-child':'sub-block';

  const head=document.createElement('div');
  head.className=isChild?'sub-child-head':'sub-head';
  head.innerHTML=`
    <div class="sub-head-title" contenteditable="true">${mod.title}</div>
    <select>
      <option ${mod.owner==='Audi√≥logo'?'selected':''}>Audi√≥logo</option>
      <option ${mod.owner==='Responsable'?'selected':''}>Responsable</option>
      <option ${mod.owner==='Otros'?'selected':''}>Otros</option>
    </select>
    <div class="head-actions">
      <button class="btn3d" style="transform:scale(.7)"><span class="icon">üìù</span>Detalle</button>
      <button class="btn3d" style="transform:scale(.7)"><span class="icon">‚ûï</span>Paso</button>
      <button class="btn3d" style="transform:scale(.7)"><span class="icon">‚ûï</span>Sub/subproceso</button>
      <span class="badge-save"><span class="icon">üíæ</span>Guardar</span>
      <button class="btn3d" style="transform:scale(.7)"><span class="icon">‚úñ</span></button>
    </div>`;
  const titleEl=head.querySelector('.sub-head-title');
  titleEl.oninput=()=>{mod.title=titleEl.textContent.trim()||'Subproceso';};
  const [sel]=head.getElementsByTagName('select');
  sel.onchange=e=>{mod.owner=e.target.value;saveState();};
  const [btnDet,btnPaso,btnSubSub,btnSave,btnDel]=head.querySelectorAll('.head-actions > *');
  btnDet.onclick=()=>{
    const txt=prompt('Detalle del subproceso',mod.detail||'');
    if(txt!==null){mod.detail=txt;saveState();}
  };
  btnPaso.onclick=()=>{mod.steps.push(defaultStep());saveState();renderSubprocs();};
  btnSubSub.onclick=()=>{
    const child=defaultModule(true);
    mod.children.push(child);
    saveState();renderSubprocs();
  };
  btnSave.onclick=()=>{saveState();toast('Subproceso guardado');};
  btnDel.onclick=()=>{
    if(!confirm('¬øEliminar este subproceso con todos sus pasos y sub-subprocesos?'))return;
    proc.modules=proc.modules.filter(m=>m.id!==mod.id);
    saveState();renderSubprocs();
  };

  block.appendChild(head);

  const stepsArea=document.createElement('div');
  stepsArea.className='steps-area';
  const grid=document.createElement('div');
  grid.className='steps-grid';
  mod.steps.forEach((st,idx)=>grid.appendChild(buildStep(mod,st,idx,proc.color)));
  stepsArea.appendChild(grid);
  block.appendChild(stepsArea);

  mod.children.forEach(ch=>block.appendChild(buildModule(ch,true,proc)));

  return block;
}

/* ======= PASO ======= */
function buildStep(mod,st,idx,procColor){
  const wrap=document.createElement('div');
  wrap.className='step-wrap';
  wrap.dataset.stepId=st.id;

  const card=document.createElement('div');
  card.className='step-card';
  card.innerHTML=`
    <div class="step-strip"></div>
    <div class="step-badge">${idx+1}</div>
    <div class="step-title" contenteditable="true">${st.title}</div>
    <button class="step-edit">‚úèÔ∏è</button>
    <div class="step-detail ${st.collapsedDetail?'':'open'}">
      <div class="sn-row">
        <div class="sn-col">
          <h4>S√ç</h4>
          <textarea placeholder="Acciones si se cumple‚Ä¶">${st.yes||''}</textarea>
        </div>
        <div class="sn-col">
          <h4>NO</h4>
          <textarea placeholder="Acciones si NO se cumple‚Ä¶">${st.no||''}</textarea>
        </div>
      </div>
      <div class="next-proc">Etiqueta ‚ÄúIr a pr√≥ximo proceso‚Äù (escribe aqu√≠ si aplica)</div>
      <textarea style="width:100%;margin-top:.25rem;min-height:32px;border-radius:8px;border:1px solid #e5e7eb;padding:.25rem .35rem;font-size:12px;">${st.detail||''}</textarea>
    </div>`;

  /* color pastel del proceso en la banda y el punto */
  const strip=card.querySelector('.step-strip');
  const badge=card.querySelector('.step-badge');
  if(procColor){
    strip.style.background=procColor;
    badge.style.background=procColor;
  }

  const titleEl=card.querySelector('.step-title');
  titleEl.oninput=()=>{st.title=titleEl.textContent.trim()||'Paso';};

  const detailBox=card.querySelector('.step-detail');
  const [yesTA,noTA,detailTA]=detailBox.querySelectorAll('textarea');
  yesTA.oninput=()=>{st.yes=yesTA.value;saveState();};
  noTA.oninput=()=>{st.no=noTA.value;saveState();};
  detailTA.oninput=()=>{st.detail=detailTA.value;saveState();};

  /* men√∫ l√°piz */
  const editBtn=card.querySelector('.step-edit');
  let menu=null;
  editBtn.onclick=e=>{
    e.stopPropagation();
    if(menu){menu.remove();menu=null;return;}
    menu=document.createElement('div');
    menu.className='edit-menu';
    menu.innerHTML=`
      <button title="Guardar">üíæ</button>
      <button title="Adjuntar documento">üìé</button>
      <button title="Adjuntar enlace">üîó</button>
      <button title="Ayuda">‚ùì</button>
      <button title="Eliminar">üóë</button>`;
    const [bSave,bDoc,bLink,bHelp,bDel]=menu.querySelectorAll('button');
    bSave.onclick=()=>{saveState();toast('Paso guardado');};
    bDoc.onclick=()=>{
      const inp=document.createElement('input');
      inp.type='file';
      inp.onchange=()=>toast('Documento adjuntado (referencia local)');
      inp.click();
    };
    bLink.onclick=()=>{
      const url=prompt('Pega el enlace a adjuntar');
      if(url)toast('Enlace guardado en el paso');
    };
    bHelp.onclick=()=>alert('Puedes usar este paso para documentar instrucciones o ayudas.');
    bDel.onclick=()=>{
      if(!confirm('¬øEliminar este paso?'))return;
      mod.steps=mod.steps.filter(x=>x.id!==st.id);
      saveState();renderSubprocs();
    };
    card.appendChild(menu);
  };

  /* ver m√°s */
  const pill=document.createElement('div');
  pill.className='more-pill';
  pill.innerHTML=`<strong>ver m√°s</strong><span class="hand">üëá</span>`;
  const showPill=()=>{ if(yesTA.value||noTA.value||detailTA.value) pill.style.display='inline-flex'; };
  if(!st.yes && !st.no && !st.detail && st.collapsedDetail) pill.style.display='none';
  yesTA.addEventListener('input',showPill);
  noTA.addEventListener('input',showPill);
  detailTA.addEventListener('input',showPill);

  pill.onclick=()=>{
    st.collapsedDetail=!st.collapsedDetail;
    if(st.collapsedDetail) detailBox.classList.remove('open');
    else detailBox.classList.add('open');
    saveState();
  };

  wrap.appendChild(card);
  wrap.appendChild(pill);
  return wrap;
}

/* ======= LAYOUT SERPENTINA 1-2-3 / 6-5-4 ======= */
function layoutStepsSerpentine(container){
  const wraps=[...container.querySelectorAll('.step-wrap')];
  if(!wraps.length)return;

  const firstCard=wraps[0].querySelector('.step-card');
  const cardW=firstCard.offsetWidth||260;
  const cardH=firstCard.offsetHeight||110;
  const gapX=24,gapY=40;
  const cols=3;

  const rows=Math.ceil(wraps.length/cols);
  for(let i=0;i<wraps.length;i++){
    const row=Math.floor(i/cols);
    const idxInRow=i%cols;
    const col = (row%2===0) ? idxInRow : (cols-1-idxInRow); // fila impar invertida

    const x=col*(cardW+gapX);
    const y=row*(cardH+gapY);
    const w=wraps[i];
    w.style.left=x+'px';
    w.style.top=y+'px';
  }
  container.style.height=rows*(cardH+gapY)+20+'px';
}
function layoutAllSteps(){
  document.querySelectorAll('.steps-grid').forEach(layoutStepsSerpentine);
}

/* ======= FLECHAS 1‚Üí2‚Üí3‚Üí4 (respeta serpentina) ======= */
function drawAllFlows(){
  document.querySelectorAll('.steps-area').forEach(area=>{
    const old=area.querySelector('.flow-svg');
    if(old)old.remove();
    const grid=area.querySelector('.steps-grid');
    if(!grid)return;
    const cards=[...grid.querySelectorAll('.step-card')];
    if(cards.length<2)return;

    const rect=grid.getBoundingClientRect();
    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg');
    svg.classList.add('flow-svg');
    svg.setAttribute('viewBox',`0 0 ${rect.width} ${rect.height}`);

    const defs=document.createElementNS(svgNS,'defs');
    const marker=document.createElementNS(svgNS,'marker');
    marker.setAttribute('id','arrowHead');
    marker.setAttribute('markerWidth','8');
    marker.setAttribute('markerHeight','8');
    marker.setAttribute('refX','7');
    marker.setAttribute('refY','4');
    marker.setAttribute('orient','auto');
    const head=document.createElementNS(svgNS,'path');
    head.setAttribute('d','M0,0 L8,4 L0,8 Z');
    head.setAttribute('fill','#d1d5db');
    marker.appendChild(head);
    defs.appendChild(marker);
    svg.appendChild(defs);

    const rects=cards.map(c=>c.getBoundingClientRect());

    function anchorRight(r){
      return {x:r.right-rect.left,y:(r.top+r.bottom)/2-rect.top};
    }
    function anchorLeft(r){
      return {x:r.left-rect.left,y:(r.top+r.bottom)/2-rect.top};
    }

    for(let i=0;i<cards.length-1;i++){
      const a=rects[i],b=rects[i+1];
      const s=anchorRight(a),e=anchorLeft(b);
      const sameRow=Math.abs(a.top-b.top)<20;
      const path=document.createElementNS(svgNS,'path');
      let d;

      if(sameRow){
        const midX=(s.x+e.x)/2;
        d=`M ${s.x} ${s.y} C ${midX} ${s.y} ${midX} ${e.y} ${e.x} ${e.y}`;
      }else{
        const downY=s.y+20;
        const upY=e.y-20;
        const midX=s.x+40;
        d=`M ${s.x} ${s.y}
           L ${s.x+20} ${s.y}
           L ${s.x+20} ${downY}
           L ${midX} ${downY}
           L ${midX} ${upY}
           L ${e.x-10} ${upY}
           L ${e.x-10} ${e.y}
           L ${e.x} ${e.y}`;
      }
      path.setAttribute('d',d);
      path.setAttribute('fill','none');
      path.setAttribute('stroke','#d1d5db');
      path.setAttribute('stroke-width','3');
      path.setAttribute('marker-end','url(#arrowHead)');
      svg.appendChild(path);
    }

    area.appendChild(svg);
  });
}

/* ======= PIN LECTURA ======= */
function applyPin(){
  const locked=sessionStorage.getItem('PA_PIN_OK')!=='1';
  document.body.classList.toggle('pa-locked',locked);
}
document.getElementById('btnPin').onclick=()=>{
  if(sessionStorage.getItem('PA_PIN_OK')==='1'){
    sessionStorage.removeItem('PA_PIN_OK');
    applyPin();toast('Modo lectura activado');
  }else{
    const v=prompt('Introduce PIN para editar (AR4321)');
    if(v===PIN_CODE){sessionStorage.setItem('PA_PIN_OK','1');applyPin();toast('Edici√≥n habilitada');}
    else if(v!==null)toast('PIN incorrecto');
  }
};

/* ======= BUSCADOR ======= */
document.getElementById('globalSearch').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase().trim();
  document.querySelectorAll('.proc-item').forEach(el=>{
    const txt=el.querySelector('.proc-name').textContent.toLowerCase();
    el.style.display=(!q||txt.includes(q))?'flex':'none';
  });
});

/* ======= NUEVO DEPARTAMENTO ======= */
document.getElementById('btnNewDept').onclick=()=>{
  const name=prompt('Nombre del nuevo departamento','Nuevo departamento');
  if(!name)return;
  const d=defaultDept();d.name=name;d.processes=[];
  state.depts.push(d);
  state.activeDeptId=d.id;
  state.activeProcId=null;
  saveState();renderAll();
};

/* ======= TOOLS TOPBAR ======= */
document.getElementById('btnGlobalSave').onclick=()=>{saveState();toast('Todo guardado');};

document.getElementById('btnHtml').onclick=()=>{
  const clone=document.documentElement.cloneNode(true);
  clone.querySelectorAll('#toast').forEach(n=>n.remove());
  const blob=new Blob(['<!DOCTYPE html>\n'+clone.outerHTML],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='procesos-audio.html';
  document.body.appendChild(a);a.click();a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
};

document.getElementById('btnCloudSave').onclick=()=>{
  try{
    localStorage.setItem('pa_snapshot_html_v1',document.documentElement.outerHTML);
    toast('Copia guardada en nube local');
  }catch(e){toast('No se pudo guardar la copia');}
};

document.getElementById('btnPdf').onclick=()=>window.print();

/* ======= RENDER GLOBAL ======= */
function renderAll(){
  renderSidebar();
  renderProcHeader();
  renderSubprocs();
  applyPin();
}

loadState();
document.getElementById('stamp').textContent='√öltima actualizaci√≥n '+nowStamp();
renderAll();
window.addEventListener('resize',()=>{layoutAllSteps();drawAllFlows();});
</script>
</body>
</html>
